<!DOCTYPE html>
<html lang="zh-CN" class="precheck-hide">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title data-i18n="admin.title">ç”¨æˆ·ç®¡ç† - Cursor Pro Trial</title>
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <noscript>
      <meta http-equiv="refresh" content="0; url=/templates/loading.html?redirect=%2Fhtml%2Fadmin.html" />
    </noscript>
    <style>.precheck-hide body{ visibility: hidden !important; }</style>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="shortcut icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/css/app.css" />
    <link rel="stylesheet" href="/css/admin.css" />
    <script src="/js/auth-guard.js" defer></script>
    <script src="/js/i18n.js" defer></script>
    <script>
      // è®¿é—®ç®¡ç†é¡µå…ˆåšå‰ç«¯å¿«é€Ÿé‰´æƒï¼Œé¿å…å†…å®¹é—ªç°ï¼›æœªç™»å½•æˆ–æƒé™ä¸è¶³å‡è¿›å…¥ loading æˆ–å›é¦–é¡µ
      (function(){
        fetch('/api/session', { headers: { 'Cache-Control': 'no-cache' } })
          .then(r => r.ok ? r.json() : Promise.reject('unauth'))
          .then(s => {
            if (s && (s.role === 'admin' || s.role === 'guest' || s.strictAdmin)){
              try{ document.documentElement.classList.remove('precheck-hide'); }catch(_){ }
              return;
            }
            // å·²ç™»å½•ä½†æ— æƒé™ï¼šå›é¦–é¡µ
            location.replace('/');
          })
          .catch(() => {
            // æœªç™»å½•ï¼šè¿›å…¥åŠ è½½é¡µåšé‰´æƒ
            if (window.AuthGuard) { window.AuthGuard.goLoading('/html/admin.html', 'æ­£åœ¨æ ¡éªŒæƒé™â€¦'); }
            else { location.replace('/templates/loading.html?redirect=%2Fhtml%2Fadmin.html&status=' + encodeURIComponent('æ­£åœ¨æ ¡éªŒæƒé™â€¦')); }
          });
      })();
    </script>
  </head>
  <body class="admin-page">
    <div class="topbar">
      <div class="brand">
        <span class="brand-icon">ğŸ› ï¸</span>
        <span data-i18n="topbar.userManagement">Cursor Pro Trial - ç”¨æˆ·ç®¡ç†</span>
      </div>
      <div class="nav-actions">
        <button id="language-switcher" class="btn btn-ghost" title="Switch Language">
          <span class="btn-icon">ğŸ‡ºğŸ‡¸</span>
          <span class="btn-text">English</span>
        </button>
        <button id="back" class="btn btn-ghost" data-i18n-title="admin.backToMailbox" data-i18n="admin.backToMailbox">è¿”å›é‚®ç®±</button>
        <button id="logout" class="btn btn-secondary" data-i18n-title="topbar.logout" data-i18n="topbar.logout">é€€å‡ºç™»å½•</button>
      </div>
    </div>
    <div id="demo-banner" class="demo-banner" style="display:none">å½“å‰ä¸ºæ¼”ç¤ºç®¡ç†é¡µï¼šæ‰€æœ‰æ”¹åŠ¨ä»…åœ¨æµè§ˆå™¨ä¼šè¯ä¸­æ¨¡æ‹Ÿ</div>
    <div class="admin-container">
      <div class="admin-left">
        <div class="card">
          <h2><span class="card-icon">ğŸ‘¤</span><span data-i18n="admin.userManagement">ç”¨æˆ·ç®¡ç†</span></h2>
          <div class="generate-action"><button id="u-open" class="btn btn-primary" data-i18n="admin.createUser">åˆ›å»ºç”¨æˆ·</button></div>
          <div class="generate-action"><button id="a-open" class="btn btn-primary" data-i18n="admin.assignMailbox">åˆ†é…é‚®ç®±</button></div>
        </div>
   
        <div class="card">
          <h2><span class="card-icon">ğŸ“¦</span><span data-i18n="admin.userMailboxes">ç”¨æˆ·çš„é‚®ç®±åˆ—è¡¨</span></h2>
          <div id="user-mailboxes-loading" class="loading-indicator" style="margin: 4px 0 8px 0; display:none">
            <div class="spinner"></div>
            <span data-i18n="admin.loading">åŠ è½½ä¸­â€¦</span>
          </div>
          <div id="user-mailboxes"></div>
        </div>
      </div>
      <div class="admin-right">
        <div class="card">
          <div class="card-header">
            <h2><span class="card-icon">ğŸ“‹</span><span data-i18n="admin.userList">ç”¨æˆ·åˆ—è¡¨</span></h2>
            <button id="users-refresh" class="btn btn-ghost btn-sm" data-i18n-title="admin.refreshTooltip" data-i18n="admin.refresh">åˆ·æ–°</button>
          </div>
          <div id="users-loading" class="loading-indicator" style="margin: 4px 0 8px 0">
            <div class="spinner"></div>
            <span data-i18n="admin.loading">åŠ è½½ä¸­â€¦</span>
          </div>
          <div style="overflow:auto; max-height: 420px">
            <table class="table">
              <thead>
                <tr>
                  <th class="col-id" style="text-align:left;padding:8px;border-bottom:1px solid var(--border-light)" data-i18n="admin.id">ID</th>
                  <th class="col-username" style="text-align:left;padding:8px;border-bottom:1px solid var(--border-light)" data-i18n="admin.username">ç”¨æˆ·å</th>
                  <th class="col-role" style="text-align:left;padding:8px;border-bottom:1px solid var(--border-light)" data-i18n="admin.role">è§’è‰²</th>
                  <th class="col-mailbox" style="text-align:left;padding:8px;border-bottom:1px solid var(--border-light)" data-i18n="admin.mailboxCount">é‚®ç®±æ•°é‡</th>
                  <th class="col-can" style="text-align:left;padding:8px;border-bottom:1px solid var(--border-light)" data-i18n="admin.canSend">èƒ½å¦å‘ä»¶</th>
                  <th class="col-created" style="text-align:left;padding:8px;border-bottom:1px solid var(--border-light)" data-i18n="admin.createdTime">åˆ›å»ºæ—¶é—´</th>
                  <th class="col-actions" style="text-align:left;padding:8px;border-bottom:1px solid var(--border-light)" data-i18n="admin.actions">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="users-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="toast" class="toast"></div>

      <!-- ç¼–è¾‘ç”¨æˆ· äºŒçº§é¡µé¢ -->
      <div class="modal" id="edit-modal">
        <div class="modal-card">
          <div class="modal-header">
            <div>
              <span class="modal-icon">ğŸ› ï¸</span>
              <span data-i18n="admin.editUser">ç¼–è¾‘ç”¨æˆ·</span>
              <span id="edit-user-display" class="user-chip"></span>
            </div>
            <button id="edit-close" class="close">âœ•</button>
          </div>
          <div class="modal-body">
            <div class="form-grid">
              <div>
                <label class="config-label" data-i18n="admin.newPassword">æ–°å¯†ç </label>
                <input id="edit-pass" class="input" type="password" data-i18n-placeholder="admin.newPasswordPlaceholder" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹" />
              </div>
              <div>
                <label class="config-label" data-i18n="admin.newUsername">æ–°ç”¨æˆ·å</label>
                <input id="edit-new-name" class="input" data-i18n-placeholder="admin.newUsernamePlaceholder" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹" />
              </div>
              <div>
                <label class="config-label" data-i18n="admin.mailboxLimit">é‚®ç®±ä¸Šé™</label>
                <input id="edit-limit" class="input" type="number" min="0" />
              </div>
            </div>
            <div class="checks-row">
              <label class="toggle"><input id="edit-role-check" type="checkbox" /><span data-i18n="admin.advancedUser">é«˜çº§ç”¨æˆ·</span></label>
              <label class="toggle"><input id="edit-send-check" type="checkbox" /><span data-i18n="admin.allowSend">å…è®¸å‘ä»¶</span></label>
            </div>
          </div>
          <div class="modal-footer" style="display:flex;gap:8px;justify-content:flex-end;padding:12px 16px">
            <button id="edit-cancel" class="btn btn-secondary" data-i18n="common.cancel">å–æ¶ˆ</button>
            <button id="edit-save" class="btn btn-primary" data-i18n="common.save">ä¿å­˜</button>
            <button id="edit-delete" class="btn btn-danger" data-i18n="admin.deleteUser">åˆ é™¤ç”¨æˆ·</button>
          </div>
        </div>
      </div>

      <!-- è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†ï¼ˆåˆ é™¤ç”¨æˆ·ï¼‰ -->
      <div class="modal" id="admin-confirm-modal">
        <div class="modal-card confirm-card">
          <div class="modal-header confirm-header">
            <div>
              <span class="modal-icon">âš ï¸</span>
              <span data-i18n="admin.confirmOperation">ç¡®è®¤æ“ä½œ</span>
            </div>
            <button id="admin-confirm-close" class="close">âœ•</button>
          </div>
          <div class="modal-body confirm-body">
            <div id="admin-confirm-message" class="confirm-message"></div>
            <div class="confirm-actions">
              <button id="admin-confirm-cancel" class="btn btn-secondary" data-i18n="common.cancel">å–æ¶ˆ</button>
              <button id="admin-confirm-ok" class="btn btn-danger" data-i18n="common.ok">ç¡®å®š</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal" id="u-modal">
        <div class="modal-card">
          <div class="modal-header">
            <div>
              <span class="modal-icon">ğŸ‘¤</span>
              <span data-i18n="admin.createUserTitle">åˆ›å»ºç”¨æˆ·</span>
            </div>
            <button id="u-close" class="close">âœ•</button>
          </div>
          <div class="modal-body">
            <div class="config-form">
              <div class="config-item"><label class="config-label" data-i18n="admin.usernameLabel">ç”¨æˆ·å</label><input id="u-name" class="input" data-i18n-placeholder="admin.usernamePlaceholder" placeholder="username" /></div>
              <div class="config-item"><label class="config-label" data-i18n="admin.passwordLabel">å¯†ç </label><input id="u-pass" class="input" type="password" data-i18n-placeholder="admin.passwordPlaceholder" placeholder="password" /></div>
              <div class="config-item"><label class="config-label" data-i18n="admin.roleLabel">è§’è‰²</label><select id="u-role" class="select"><option value="user" data-i18n="admin.normalUser">æ™®é€šç”¨æˆ·</option><option value="admin" data-i18n="admin.adminUser">é«˜çº§ç”¨æˆ·</option></select></div>
            </div>
          </div>
          <div class="modal-footer" style="display:flex;gap:8px;justify-content:flex-end;padding:12px 16px">
            <button id="u-cancel" class="btn btn-secondary" data-i18n="common.cancel">å–æ¶ˆ</button>
            <button id="u-create" class="btn btn-primary" data-i18n="common.create">åˆ›å»º</button>
          </div>
        </div>
      </div>

      <div class="modal" id="a-modal">
        <div class="modal-card">
          <div class="modal-header">
            <div>
              <span class="modal-icon">ğŸ“¬</span>
              <span data-i18n="admin.assignMailboxTitle">åˆ†é…é‚®ç®±</span>
            </div>
            <button id="a-close" class="close">âœ•</button>
          </div>
          <div class="modal-body">
            <div class="config-form">
              <div class="config-item"><label class="config-label" data-i18n="admin.usernameLabel">ç”¨æˆ·å</label><input id="a-name" class="input" data-i18n-placeholder="admin.usernamePlaceholder" placeholder="username" /></div>
              <div class="config-item">
                <label class="config-label" data-i18n="admin.mailboxAddresses">é‚®ç®±åœ°å€</label>
                <textarea id="a-mail" class="input" data-i18n-placeholder="admin.mailboxPlaceholder" placeholder="foo@example.com&#10;bar@example.com&#10;baz@example.com" rows="4"></textarea>
                <div class="help-text" data-i18n="admin.mailboxHint">æ¯è¡Œä¸€ä¸ªé‚®ç®±åœ°å€ï¼Œæ”¯æŒæ‰¹é‡åˆ†é…</div>
              </div>
            </div>
          </div>
          <div class="modal-footer" style="display:flex;gap:8px;justify-content:flex-end;padding:12px 16px">
            <button id="a-cancel" class="btn btn-secondary" data-i18n="common.cancel">å–æ¶ˆ</button>
            <button id="a-assign" class="btn btn-primary" data-i18n="admin.assign">åˆ†é…</button>
          </div>
        </div>
      </div>
    </div>
    <div id="footer-slot"></div>
    <script type="module" src="/js/admin.js"></script>
    <script>
      // åŠ¨æ€åŠ è½½å…¬å…± footer æ¨¡æ¿ï¼Œå¹¶åœ¨å®¿ä¸»é¡µé¢è®¾ç½®å¹´ä»½ï¼Œç¡®ä¿æ‰§è¡Œ
      (async function(){
        try{
          const res = await fetch('/templates/footer.html', { cache: 'no-cache' });
          const html = await res.text();
          const slot = document.getElementById('footer-slot');
          if (slot){
            slot.outerHTML = html;
            // ç­‰ DOM æ›´æ–°åå¡«å……å¹´ä»½
            setTimeout(() => {
              const y = document.getElementById('footer-year');
              if (y) y.textContent = new Date().getFullYear();
            }, 0);
          }
        }catch(_){ }
      })();
    </script>
  </body>
  </html>


